import random
import json
import os
import re
from difflib import SequenceMatcher

class AcertijoManager:
    def __init__(self, acertijos_file="acertijos.json"):
        """
        Inicializar el manager del modo acertijos
        """
        self.acertijos_file = acertijos_file
        self.acertijos = []
        self.acertijo_actual = None
        self.intentos_fallidos = {}  # username: numero_intentos
        self.ganadores = {}  # username: numero_aciertos
        self.load_acertijos()
        print(f"üß© Acertijo Manager inicializado con {len(self.acertijos)} acertijos")
    
    def load_acertijos(self):
        """Cargar acertijos desde archivo JSON o crear por defecto"""
        try:
            if os.path.exists(self.acertijos_file):
                with open(self.acertijos_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    self.acertijos = data.get('acertijos', [])
                    self.ganadores = data.get('ganadores', {})
                print(f"‚úÖ Cargados {len(self.acertijos)} acertijos desde {self.acertijos_file}")
            else:
                self._create_default_acertijos()
                self.save_acertijos()
                print(f"üß© Archivo de acertijos creado: {self.acertijos_file}")
        
        except Exception as e:
            print(f"‚ùå Error cargando acertijos: {e}")
            self._create_default_acertijos()
    
    def _create_default_acertijos(self):
        """Crear acertijos por defecto"""
        self.acertijos = [
            {
                "pregunta": "Tengo agujas pero no coso, tengo n√∫meros pero no soy matem√°tico. ¬øQu√© soy?",
                "respuestas": ["reloj", "reloj de pared", "cronometro", "cron√≥metro"],
                "pistas": ["Mido el tiempo", "Estoy en la pared", "Hago tic-tac"],
                "dificultad": "f√°cil",
                "categoria": "objetos"
            },
            {
                "pregunta": "Blanco por dentro, verde por fuera. Si quieres que te lo diga, espera.",
                "respuestas": ["pera", "la pera"],
                "pistas": ["Es una fruta", "Tiene forma de gota", "Rima con espera"],
                "dificultad": "f√°cil",
                "categoria": "frutas"
            },
            {
                "pregunta": "Vuelo sin alas, lloro sin ojos. Donde quiera que voy, la oscuridad me sigue. ¬øQu√© soy?",
                "respuestas": ["nube", "las nubes", "una nube"],
                "pistas": ["Estoy en el cielo", "Traigo lluvia", "Bloqueo el sol"],
                "dificultad": "medio",
                "categoria": "naturaleza"
            },
            {
                "pregunta": "Tengo ciudades, pero no casas. Tengo monta√±as, pero no √°rboles. Tengo agua, pero no peces. ¬øQu√© soy?",
                "respuestas": ["mapa", "un mapa", "el mapa"],
                "pistas": ["Me usan para ubicarse", "Soy de papel", "Muestro lugares"],
                "dificultad": "medio",
                "categoria": "objetos"
            },
            {
                "pregunta": "Cuanto m√°s seco, m√°s mojado. ¬øQu√© soy?",
                "respuestas": ["toalla", "la toalla", "una toalla"],
                "pistas": ["Me usan despu√©s del ba√±o", "Absorbo agua", "Cuelgo en el ba√±o"],
                "dificultad": "f√°cil",
                "categoria": "objetos"
            },
            {
                "pregunta": "Todos me pisan, todos me usan, pero nadie me ve. ¬øQu√© soy?",
                "respuestas": ["camino", "el camino", "sendero", "senda"],
                "pistas": ["Conecta lugares", "La gente camina sobre m√≠", "Puedo ser de tierra"],
                "dificultad": "medio",
                "categoria": "lugares"
            },
            {
                "pregunta": "Tengo dientes pero no como. ¬øQu√© soy?",
                "respuestas": ["peine", "el peine", "sierra", "engranaje", "cremallera"],
                "pistas": ["Ordeno el cabello", "Tengo muchas puntas", "Soy de pl√°stico"],
                "dificultad": "f√°cil",
                "categoria": "objetos"
            },
            {
                "pregunta": "En el circo soy el rey, con mi cara pintada y mi nariz colorada. ¬°Hago re√≠r a la gente pero a veces doy miedo! ¬øQui√©n soy?",
                "respuestas": ["payaso", "el payaso", "un payaso", "clown"],
                "pistas": ["Trabajo en el circo", "Hago bromas", "Mi nariz es roja"],
                "dificultad": "f√°cil",
                "categoria": "personajes"
            },
            {
                "pregunta": "Redondo como una pelota, dulce como la miel, me comes en el desayuno con caf√© o con t√©. ¬øQu√© soy?",
                "respuestas": ["donut", "dona", "rosquilla", "rosquita"],
                "pistas": ["Tengo un agujero en el centro", "Soy dulce", "Me fr√≠en en aceite"],
                "dificultad": "f√°cil",
                "categoria": "comida"
            },
            {
                "pregunta": "Si me nombras, desaparezco. ¬øQu√© soy?",
                "respuestas": ["silencio", "el silencio"],
                "pistas": ["Soy la ausencia de algo", "Existo cuando no hay ruido", "Los bibliotecarios me aman"],
                "dificultad": "dif√≠cil",
                "categoria": "conceptos"
            },
            {
                "pregunta": "Cuanto m√°s le quitas, m√°s grande se hace. ¬øQu√© es?",
                "respuestas": ["hoyo", "el hoyo", "agujero", "el agujero", "hueco"],
                "pistas": ["Se hace cavando", "Puede ser profundo", "Los mineros me hacen"],
                "dificultad": "medio",
                "categoria": "conceptos"
            },
            {
                "pregunta": "Tengo cola pero no soy animal, tengo cabeza pero no pienso. Me lanzan al aire y decido por ti. ¬øQu√© soy?",
                "respuestas": ["moneda", "la moneda", "una moneda"],
                "pistas": ["Sirvo para comprar", "Tengo dos caras", "Estoy hecha de metal"],
                "dificultad": "medio",
                "categoria": "objetos"
            },
            {
                "pregunta": "Soy amarillo por fuera, blanco por dentro. Los monos me aman y los ni√±os tambi√©n. ¬øQu√© soy?",
                "respuestas": ["pl√°tano", "banana", "el pl√°tano", "la banana"],
                "pistas": ["Crezco en racimos", "Soy tropical", "Tengo potasio"],
                "dificultad": "f√°cil",
                "categoria": "frutas"
            },
            {
                "pregunta": "Entro seco y salgo mojado, mientras m√°s me secan m√°s mojado quedo. ¬øQu√© soy?",
                "respuestas": ["t√©", "el t√©", "caf√©", "el caf√©", "chocolate"],
                "pistas": ["Soy una bebida", "Me preparan con agua caliente", "Tengo sabor"],
                "dificultad": "dif√≠cil",
                "categoria": "bebidas"
            },
            {
                "pregunta": "Tengo ojos pero no veo, tengo papas pero no como. ¬øQu√© soy?",
                "respuestas": ["papa", "patata", "la papa", "la patata"],
                "pistas": ["Crezco bajo tierra", "Me pueden fre√≠r", "Tengo almid√≥n"],
                "dificultad": "medio",
                "categoria": "comida"
            }
        ]
        
        self.ganadores = {}
    
    def get_acertijo_aleatorio(self):
        """Obtener un acertijo aleatorio"""
        if not self.acertijos:
            return "¬°No tengo acertijos! ¬°Mi cerebro est√° m√°s vac√≠o que mi coraz√≥n!"
        
        self.acertijo_actual = random.choice(self.acertijos)
        self.intentos_fallidos = {}  # Reset intentos
        
        difficulty_emoji = {
            "f√°cil": "üü¢",
            "medio": "üü°", 
            "dif√≠cil": "üî¥"
        }
        
        emoji = difficulty_emoji.get(self.acertijo_actual["dificultad"], "‚ùì")
        
        return f"üß© ACERTIJO {emoji}:\n\n{self.acertijo_actual['pregunta']}\n\n¬°A ver si no eres tan tonto como pareces!"
    
    def verificar_respuesta(self, username, respuesta):
        """Verificar si la respuesta es correcta"""
        if not self.acertijo_actual:
            return "¬°No hay acertijo activo, genio!"
        
        respuesta_limpia = self._limpiar_respuesta(respuesta)
        respuestas_correctas = [self._limpiar_respuesta(r) for r in self.acertijo_actual["respuestas"]]
        
        # Verificar respuesta exacta
        if respuesta_limpia in respuestas_correctas:
            return self._respuesta_correcta(username)
        
        # Verificar respuesta similar (tolerancia para errores menores)
        for respuesta_correcta in respuestas_correctas:
            similarity = SequenceMatcher(None, respuesta_limpia, respuesta_correcta).ratio()
            if similarity > 0.8:  # 80% de similitud
                return self._respuesta_correcta(username)
        
        return self._respuesta_incorrecta(username)
    
    def _limpiar_respuesta(self, respuesta):
        """Limpiar respuesta para comparaci√≥n"""
        # Convertir a min√∫sculas y quitar espacios extra
        respuesta_limpia = respuesta.lower().strip()
        
        # Remover art√≠culos y palabras comunes
        palabras_ignorar = ["el", "la", "los", "las", "un", "una", "es", "soy"]
        palabras = respuesta_limpia.split()
        palabras_filtradas = [p for p in palabras if p not in palabras_ignorar]
        
        # Unir palabras o devolver original si queda vac√≠o
        return " ".join(palabras_filtradas) if palabras_filtradas else respuesta_limpia
    
    def _respuesta_correcta(self, username):
        """Manejar respuesta correcta"""
        # Actualizar puntuaci√≥n
        if username in self.ganadores:
            self.ganadores[username] += 1
        else:
            self.ganadores[username] = 1
        
        # Limpiar intentos fallidos
        if username in self.intentos_fallidos:
            del self.intentos_fallidos[username]
        
        # Guardar progreso
        self.save_acertijos()
        
        # Respuestas de felicitaci√≥n sarc√°sticas
        felicitaciones = [
            f"¬°Correcto, {username}! ¬°Hasta un reloj descompuesto da la hora correcta dos veces al d√≠a!",
            f"¬°Bien {username}! ¬°Por fin usaste esa cosa que tienes entre las orejas!",
            f"¬°Exacto, {username}! ¬°Veo que no eres tan in√∫til como pens√©!",
            f"¬°Correcto, {username}! ¬°Felicidades por tener m√°s de dos neuronas funcionando!",
            f"¬°Bien {username}! ¬°Hasta los monos pueden aprender trucos!",
            f"¬°Correcto, {username}! ¬°Tu mam√° estar√≠a orgullosa... si supiera usar internet!",
            f"¬°Exacto, {username}! ¬°No todo est√° perdido contigo!"
        ]
        
        respuesta = random.choice(felicitaciones)
        respuesta += f"\n\nüèÜ Llevas {self.ganadores[username]} acertijos correctos."
        
        # Limpiar acertijo actual
        self.acertijo_actual = None
        
        return respuesta
    
    def _respuesta_incorrecta(self, username):
        """Manejar respuesta incorrecta"""
        # Incrementar intentos fallidos
        if username in self.intentos_fallidos:
            self.intentos_fallidos[username] += 1
        else:
            self.intentos_fallidos[username] = 1
        
        intentos = self.intentos_fallidos[username]
        
        # Respuestas de burla escaladas
        if intentos == 1:
            burlas = [
                f"¬°Incorrecto, {username}! ¬°Pero no te preocupes, todos empezamos siendo tontos!",
                f"¬°Fallaste, {username}! ¬°Int√©ntalo de nuevo, a ver si la suerte te acompa√±a!",
                f"¬°Nope, {username}! ¬°Tu cerebro necesita m√°s ejercicio!",
                f"¬°Error, {username}! ¬°Pero hey, al menos participas!",
                f"¬°Incorrecto, {username}! ¬°Sigue intentando, campe√≥n!"
            ]
        elif intentos == 2:
            burlas = [
                f"¬°Otra vez mal, {username}! ¬°Tu r√©cord de fracasos va creciendo!",
                f"¬°Dos errores, {username}! ¬°Impresionante consistencia en ser malo!",
                f"¬°Fallaste de nuevo, {username}! ¬°Al menos eres constante!",
                f"¬°Segundo error, {username}! ¬°Vas por buen camino... al fracaso!"
            ]
        elif intentos == 3:
            burlas = [
                f"¬°Tres errores, {username}! ¬°Eres todo un profesional... del fracaso!",
                f"¬°Triple falla, {username}! ¬°Tu talento para errar es impresionante!",
                f"¬°Tercera vez mal, {username}! ¬°Deber√≠as dedicarte a otra cosa!"
            ]
        else:
            burlas = [
                f"¬°{intentos} errores, {username}! ¬°Ya perd√≠ la cuenta de tus fracasos!",
                f"¬°Sigues fallando, {username}! ¬°Al menos eres entretenido!",
                f"¬°{intentos} intentos y nada, {username}! ¬°Eres una obra de arte... del desastre!"
            ]
        
        respuesta = random.choice(burlas)
        
        # Dar pista despu√©s de varios intentos
        if intentos >= 2 and self.acertijo_actual:
            pistas = self.acertijo_actual.get("pistas", [])
            if pistas:
                pista_index = min(intentos - 2, len(pistas) - 1)
                respuesta += f"\n\nüí° Pista: {pistas[pista_index]}"
        
        # Revelar respuesta despu√©s de muchos intentos
        if intentos >= 5 and self.acertijo_actual:
            respuesta_correcta = self.acertijo_actual["respuestas"][0]
            respuesta += f"\n\nü§¶ La respuesta era: {respuesta_correcta}"
            respuesta += f"\n¬°Pero {username}, ¬°ni regalada la adivinaste!"
            self.acertijo_actual = None
        
        return respuesta
    
    def dar_pista(self):
        """Dar pista del acertijo actual"""
        if not self.acertijo_actual:
            return "¬°No hay acertijo activo para dar pistas, genio!"
        
        pistas = self.acertijo_actual.get("pistas", [])
        if not pistas:
            return "¬°Este acertijo no tiene pistas! ¬°Arr√©glate como puedas!"
        
        pista = random.choice(pistas)
        return f"üí° Pista: {pista}\n\n¬°Espero que eso ayude a tu cerebro de mosquito!"
    
    def get_acertijo_by_categoria(self, categoria):
        """Obtener acertijo de una categor√≠a espec√≠fica"""
        acertijos_categoria = [a for a in self.acertijos if a.get("categoria", "").lower() == categoria.lower()]
        
        if not acertijos_categoria:
            return f"No tengo acertijos de '{categoria}', ¬°pero tengo muchos de lo in√∫til que eres!"
        
        self.acertijo_actual = random.choice(acertijos_categoria)
        self.intentos_fallidos = {}
        
        difficulty_emoji = {
            "f√°cil": "üü¢",
            "medio": "üü°", 
            "dif√≠cil": "üî¥"
        }
        
        emoji = difficulty_emoji.get(self.acertijo_actual["dificultad"], "‚ùì")
        
        return f"üß© ACERTIJO DE {categoria.upper()} {emoji}:\n\n{self.acertijo_actual['pregunta']}\n\n¬°A ver si sabes algo de {categoria}!"
    
    def get_ranking(self):
        """Obtener ranking de ganadores"""
        if not self.ganadores:
            return "¬°No hay ganadores a√∫n! ¬°Todos son igual de in√∫tiles!"
        
        ranking = sorted(self.ganadores.items(), key=lambda x: x[1], reverse=True)
        
        resultado = "üèÜ RANKING DE ACERTIJOS:\n\n"
        for i, (username, aciertos) in enumerate(ranking[:10], 1):
            medal = ["ü•á", "ü•à", "ü•â"][i-1] if i <= 3 else f"{i}."
            resultado += f"{medal} {username}: {aciertos} acertijos\n"
        
        return resultado
    
    def get_estadisticas(self):
        """Obtener estad√≠sticas generales"""
        if not self.acertijos:
            return "No hay acertijos disponibles"
        
        categorias = {}
        dificultades = {}
        
        for acertijo in self.acertijos:
            cat = acertijo.get("categoria", "sin categor√≠a")
            dif = acertijo.get("dificultad", "sin dificultad")
            
            categorias[cat] = categorias.get(cat, 0) + 1
            dificultades[dif] = dificultades.get(dif, 0) + 1
        
        stats = f"üìä Estad√≠sticas de Acertijos:\n"
        stats += f"Total: {len(self.acertijos)} acertijos\n"
        stats += f"Jugadores: {len(self.ganadores)}\n"
        
        if self.ganadores:
            total_aciertos = sum(self.ganadores.values())
            stats += f"Acertijos resueltos: {total_aciertos}\n"
        
        stats += f"\nCategor√≠as:\n"
        for cat, count in sorted(categorias.items()):
            stats += f"  - {cat}: {count}\n"
        
        stats += f"\nDificultades:\n"
        for dif, count in sorted(dificultades.items()):
            stats += f"  - {dif}: {count}\n"
        
        return stats
    
    def get_categorias(self):
        """Obtener lista de categor√≠as disponibles"""
        categorias = set(a.get("categoria", "sin categor√≠a") for a in self.acertijos)
        return sorted(categorias)
    
    def agregar_acertijo(self, pregunta, respuestas, pistas=None, dificultad="medio", categoria="personalizado"):
        """Agregar nuevo acertijo"""
        nuevo_acertijo = {
            "pregunta": pregunta,
            "respuestas": respuestas if isinstance(respuestas, list) else [respuestas],
            "pistas": pistas or [],
            "dificultad": dificultad,
            "categoria": categoria
        }
        
        self.acertijos.append(nuevo_acertijo)
        self.save_acertijos()
        print(f"‚úÖ Acertijo agregado: {categoria}")
    
    def responder_comentario_modo_acertijo(self, username, comentario):
        """Responder comentarios en modo acertijo"""
        comentario_lower = comentario.lower()
        
        # Comandos especiales
        if any(cmd in comentario_lower for cmd in ["pista", "ayuda", "hint"]):
            return self.dar_pista()
        
        if any(cmd in comentario_lower for cmd in ["ranking", "puntuacion", "puntaje"]):
            return self.get_ranking()
        
        if any(cmd in comentario_lower for cmd in ["nuevo", "otro", "siguiente"]):
            return self.get_acertijo_aleatorio()
        
        # Si hay acertijo activo, verificar respuesta
        if self.acertijo_actual:
            return self.verificar_respuesta(username, comentario)
        
        # Si no hay acertijo activo, dar uno nuevo
        return self.get_acertijo_aleatorio()
    
    def save_acertijos(self):
        """Guardar acertijos y puntuaciones en archivo JSON"""
        try:
            data = {
                "acertijos": self.acertijos,
                "ganadores": self.ganadores,
                "version": "1.0",
                "description": "Acertijos de Poncho el Payaso"
            }
            
            with open(self.acertijos_file, 'w', encoding='utf-8') as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
            
            print(f"üíæ Acertijos guardados en {self.acertijos_file}")
        
        except Exception as e:
            print(f"‚ùå Error guardando acertijos: {e}")
    
    def reload_acertijos(self):
        """Recargar acertijos desde archivo"""
        self.load_acertijos()

# --- FUNCIONES DE UTILIDAD ---
def crear_acertijos_personalizados():
    """Crear acertijos adicionales"""
    acertijos_extra = [
        {
            "pregunta": "Soy rojo cuando estoy enojado, verde cuando estoy celoso, azul cuando estoy triste. ¬øQu√© soy?",
            "respuestas": ["sem√°foro", "el sem√°foro"],
            "pistas": ["Controlo el tr√°fico", "Tengo tres colores", "Los autos me obedecen"],
            "dificultad": "medio",
            "categoria": "objetos"
        },
        {
            "pregunta": "Cuanto m√°s tiras de m√≠, m√°s corto me vuelvo. ¬øQu√© soy?",
            "respuestas": ["cigarrillo", "cigarro", "puro"],
            "pistas": ["Hago humo", "Soy malo para la salud", "Me encienden"],
            "dificultad": "dif√≠cil",
            "categoria": "objetos"
        }
    ]
    
    return acertijos_extra

# --- EJEMPLO DE USO ---
if __name__ == "__main__":
    print("üß© Probando modo acertijos...")
    
    # Crear manager
    acertijos = AcertijoManager()
    
    # Mostrar estad√≠sticas
    print("\nüìä ESTAD√çSTICAS:")
    print(acertijos.get_estadisticas())
    
    print(f"\nüìÇ CATEGOR√çAS: {', '.join(acertijos.get_categorias())}")
    
    # Probar acertijo aleatorio
    print("\nüß© ACERTIJO ALEATORIO:")
    acertijo = acertijos.get_acertijo_aleatorio()
    print(acertijo)
    
    # Simular respuestas
    print("\nüí¨ SIMULANDO RESPUESTAS:")
    usuarios_respuestas = [
        ("Juan", "reloj"),
        ("Ana", "no s√©"),
        ("Pedro", "cronometro"),
        ("Luis", "tiempo"),
        ("Maria", "reloj de pared")
    ]
    
    for usuario, respuesta in usuarios_respuestas:
        resultado = acertijos.verificar_respuesta(usuario, respuesta)
        print(f"\n{usuario}: '{respuesta}'")
        print(f"Poncho: {resultado}")
        
        if "¬°Correcto" in resultado:
            break
    
    # Mostrar ranking
    print("\n" + acertijos.get_ranking())
    
    # Probar acertijo por categor√≠a
    print(f"\nüß© ACERTIJO DE FRUTAS:")
    acertijo_fruta = acertijos.get_acertijo_by_categoria("frutas")
    print(acertijo_fruta)
    
    print("\n‚úÖ Pruebas de acertijos completadas")